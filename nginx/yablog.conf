# 可选：支持 Upgrade（将来如果有 WS/SSE）
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# Cache headers for immutable build assets and uploaded images.
# Important: do NOT cache error responses (otherwise CDNs may cache HTML/404 under `/assets/*`).
map $status $yablog_assets_cache_control {
  200 "public, max-age=2592000, immutable";
  204 "public, max-age=2592000, immutable";
  206 "public, max-age=2592000, immutable";
  default "no-store";
}
map $status $yablog_uploads_cache_control {
  200 "public, max-age=604800";
  204 "public, max-age=604800";
  206 "public, max-age=604800";
  default "no-store";
}

upstream yablog_upstream {
  # 如果 nginx 和 yablog 在同一台机器（yablog 对外映射 8787）
  server 127.0.0.1:8787;
  keepalive 32;

  # 如果 nginx 也在 docker 并与 yablog 同网络，可改成：
  # server yablog:8787;
}

server {
  listen 80;
  server_name blog.yamatu.xyz;

  # HTTP 强制跳 HTTPS
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name blog.yamatu.xyz;

  # 证书（ECC）
  ssl_certificate     /root/.acme.sh/blog.yamatu.xyz_ecc/fullchain.cer;
  ssl_certificate_key /root/.acme.sh/blog.yamatu.xyz_ecc/blog.yamatu.xyz.key;

  # TLS 设置
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 1d;
  ssl_session_tickets off;

  # OCSP Stapling（可选）
  ssl_stapling on;
  ssl_stapling_verify on;
  resolver 1.1.1.1 8.8.8.8 valid=300s;
  resolver_timeout 5s;

  # 上传/备份文件可能很大
  client_max_body_size 1024m;

  # 基础安全头
  add_header X-Frame-Options SAMEORIGIN always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy strict-origin-when-cross-origin always;
  add_header Permissions-Policy interest-cohort=() always;

  # 默认：除 /assets、/uploads 外，其它一律不缓存（防止 Cloudflare/浏览器缓存导致“更新不生效”）。
  # 注意：如果你在 Cloudflare 开了 “Cache Everything / Ignore Cache-Control”，仍需在 CF 配 Cache Rule 做 Bypass。
  add_header Cache-Control "no-store" always;
  add_header Pragma "no-cache" always;
  add_header Expires "0" always;
  add_header CDN-Cache-Control "no-store" always;
  add_header Surrogate-Control "no-store" always;

  # 如果你确认全站只走 HTTPS，可开启 HSTS（开启后不要轻易关闭）
  # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  # 日志（可选）
  access_log /var/log/nginx/yablog_access.log;
  error_log  /var/log/nginx/yablog_error.log;

  # 静态资源缓存（前端构建产物）
  location ^~ /assets/ {
    proxy_pass http://yablog_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_hide_header Cache-Control;
    proxy_hide_header CDN-Cache-Control;
    proxy_hide_header Surrogate-Control;
    add_header Cache-Control $yablog_assets_cache_control always;
    add_header CDN-Cache-Control $yablog_assets_cache_control always;
    add_header Surrogate-Control $yablog_assets_cache_control always;
  }

  # 上传图片缓存（是否防盗链由 YaBlog 后台开关控制）
  location ^~ /uploads/ {
    proxy_pass http://yablog_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_hide_header Cache-Control;
    proxy_hide_header CDN-Cache-Control;
    proxy_hide_header Surrogate-Control;
    add_header Cache-Control $yablog_uploads_cache_control always;
    add_header CDN-Cache-Control $yablog_uploads_cache_control always;
    add_header Surrogate-Control $yablog_uploads_cache_control always;
  }

  # 公共 API：永远不缓存（避免 Cloudflare 缓存导致首页/文章页数据不更新）。
  location ^~ /api/ {
    proxy_pass http://yablog_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 强制覆盖上游缓存头（防止某些代理/规则忽略上游的 no-store）
    proxy_hide_header Cache-Control;
    proxy_hide_header Pragma;
    proxy_hide_header Expires;
    proxy_hide_header CDN-Cache-Control;
    proxy_hide_header Surrogate-Control;

    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    add_header CDN-Cache-Control "no-store" always;
    add_header Surrogate-Control "no-store" always;
  }

  # 永远不要缓存后台页面/敏感 API（避免 Cloudflare/浏览器缓存导致后台“更新不生效”）。
  # Cloudflare 侧也建议对 /admin* /api/admin* /api/auth* /api/health 设置 Bypass Cache。
  location ^~ /admin {
    proxy_pass http://yablog_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_hide_header Cache-Control;
    proxy_hide_header Pragma;
    proxy_hide_header Expires;
    proxy_hide_header CDN-Cache-Control;
    proxy_hide_header Surrogate-Control;

    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    add_header CDN-Cache-Control "no-store" always;
    add_header Surrogate-Control "no-store" always;
  }

  location ^~ /api/admin {
    proxy_pass http://yablog_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_hide_header Cache-Control;
    proxy_hide_header Pragma;
    proxy_hide_header Expires;
    proxy_hide_header CDN-Cache-Control;
    proxy_hide_header Surrogate-Control;

    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    add_header CDN-Cache-Control "no-store" always;
    add_header Surrogate-Control "no-store" always;
  }

  location ^~ /api/auth {
    proxy_pass http://yablog_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_hide_header Cache-Control;
    proxy_hide_header Pragma;
    proxy_hide_header Expires;
    proxy_hide_header CDN-Cache-Control;
    proxy_hide_header Surrogate-Control;

    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    add_header CDN-Cache-Control "no-store" always;
    add_header Surrogate-Control "no-store" always;
  }

  location = /api/health {
    proxy_pass http://yablog_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_hide_header Cache-Control;
    proxy_hide_header Pragma;
    proxy_hide_header Expires;
    proxy_hide_header CDN-Cache-Control;
    proxy_hide_header Surrogate-Control;

    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    add_header CDN-Cache-Control "no-store" always;
    add_header Surrogate-Control "no-store" always;
  }

  # 其他请求交给 YaBlog（API + SPA）
  location / {
    proxy_pass http://yablog_upstream;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Upgrade（可选）
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # SPA/HTML 也永远不缓存（你的文章列表、归档、标签页等都依赖 API 数据；缓存 HTML 会导致各种“旧页面”问题）
    proxy_hide_header Cache-Control;
    proxy_hide_header Pragma;
    proxy_hide_header Expires;
    proxy_hide_header CDN-Cache-Control;
    proxy_hide_header Surrogate-Control;
    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    add_header CDN-Cache-Control "no-store" always;
    add_header Surrogate-Control "no-store" always;

    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
  }
}
